# API Internal Contract

> **@tableau/api-internal-contract-js** Small module which is included both by the javascript
> library which an external developer will include as well as the modules which are part of Tableau
> desktop and server

This module includes the models, verbs, and parameters which the external and Tableau platform code
will use. Since it is strongly versioned, when we bootstrap the communication channel between the
Tableau Platform and External code, they can agree on which version of these models to use. The
output will be published to artifactory when pushing to main, and be consumed the js-api-platform
and js-api-external modules.

[![build status](https://gitlab.tableausoftware.com/extensibility/api-internal-contract-js/badges/master/build.svg)](https://gitlab.tableausoftware.com/extensibility/api-internal-contract-js/commits/master)
[![coverage report](https://gitlab.tableausoftware.com/extensibility/api-internal-contract-js/badges/master/coverage.svg)](https://gitlab.tableausoftware.com/extensibility/api-internal-contract-js/commits/master)

## Setup

1.  Make sure you have the
    [prerequisites](https://mytableau.tableaucorp.com/display/devcode/Hybrid+Dialog+Prerequisites)
    installed.
1.  `yarn yarn-install`
1.  `yarn build` to build the project and run the tests

## Recommended Usage

If you are using this module to work on development of the Extensions or Embedding APIs, it's
recommended to grab the
[api-js-wrapper](https://gitlab.tableausoftware.com/extensibility/api-js-wrapper) project o make
local development a littl bit easier.

## Versioning

This package defines the contract between the external and platform components of our API. As such,
it's important that versioning is considered in the design. When making a change to the internal
contract, it's important to add logic which is able to ugprade and downgrade between the versions of
the API because the external components might be using an older version of the platform than the
internal ones.

### Adding a new version

When modifying the contract in a non-backward compatible way, it's necessary to create a new major
version of this library. Remember that even if the contract is compatible, we will need to support
older versions that might not have that addition/change. Do the following steps:

- Bump the version in `package.json`
- Add an alias in `package.json` for the old
  version`"@tableau/api-internal-contract-js-v<version_number>": "npm:@tableau/api-internal-contract-js@^<version_number>",`
- Run `yarn install` which will pull down the previous major version into a the node*modules folder
  under `@tableau/api-internal-contract-js*<version_number>`.
- Add necessary logic for upgrading input params, downgrading command return values and notification
  values to `src/versioning/VersionTranslations.ts` and register those functions inside of
  `src/versioning/VersionConverterFactory.ts`

Now, when and older version of the external library is running against a newer version of the
platform code, we will have the necessary translations in place.

## Workflow

Install dependencies. Run this command after cloning the repo, and again whenever dependencies
change. The yarn-install command includes a mutex which prevents Bad Things(tm) when running yarn
install.

`> yarn yarn-install`

Run a test build watch. Tests are recompiled and rerun on every save.

`> yarn test-dev`

Run a full build. This runs tests against a local chrome instance.

`> yarn build`

Run code coverage tools. It will output a report to the `coverage/lcov-report/index.html` directory.

`> yarn coverage`

Runs a build and bundles changes into the output APIs on every change. Useful for local testing.

`> yarn compile-watch`

Running tests against remote browser automation configurations. If your pipeline fails on other
browsers or you want to check them locally.

1.  Get the browserstackuser and browserstackkey values from variables in
    [gitlab settings](https://gitlab.tableausoftware.com/extensibility/api-internal-contract-js/-/settings/ci_cd).
1.  Provide the user and key to the cli as parameters.
1.  `> yarn test --browserStackUser XXX --browserStackKey XXX`

## Updating dependencies

### To update the gitlab-ci pipeline image

Follow the
[steps documented here](https://mytableau.tableaucorp.com/pages/viewpage.action?pageId=341476309)

### To update package dependencies

1.  `yarn upgrade --latest` if you want to upgrade all the dependencies in the project.
1.  `yarn upgrade <dependencyname> --latest` to do one at a time.
1.  `yarn build` to build and run tests.
1.  Fix errors / issues and update tests

### Make sure to sort package.json after edits

`npx sort-package-json` (package is built-in to npm >5)
