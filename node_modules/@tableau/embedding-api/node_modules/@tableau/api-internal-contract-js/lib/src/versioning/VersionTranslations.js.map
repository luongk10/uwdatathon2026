{"version":3,"file":"VersionTranslations.js","sourceRoot":"","sources":["../../../src/versioning/VersionTranslations.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  ClassNameKey,\n  DateStepPeriod,\n  DomainRestrictionType,\n  ExecuteParameters,\n  ExecuteResponse,\n  ExtensionBootstrapInfo,\n  ExtensionContext,\n  Notification,\n  ParameterInfo,\n  VerbId,\n  VisualId,\n  WorkbookFormatting,\n} from '../JsApiInternalContract';\nimport { NotificationId } from '../contract/Notifications';\n\n// tslint:disable:no-any\n\n/** This function is called when we receive old vers and parameters from the external before we send it to platform */\nexport type UpgradeExecuteCall = (verb: VerbId, parameters: ExecuteParameters) => { verb: VerbId; parameters: ExecuteParameters };\n\n/** This function is called when we received a response back from platform and we need to downgrade it to external's version */\nexport type DowngradeExecuteReturn = (executeResponse: ExecuteResponse) => ExecuteResponse;\n\n/** This function is called when we receive a notification from platform and we need to downgrade it to external's version */\nexport type DowngradeNotification = (notification: Notification) => Notification;\n\n// This is where we will start to define some of these translations.\n// When modifying existing models, add the requisite conversion functions here, then use them\n// in the VersionConverterFactory implementation. Import old versions as you would any other module\n\n// 0 <-> Translations\n// Uncomment this line to import from the V0 definition of the API\n// import * as V0 from '@tableau/api-internal-contract-js-v0';\n\n// 1 <-> 2 Translations\n// Uncomment this line to import from the V1 definition of the API\n// import * as V1 from '@tableau/api-internal-contract-js-v1';\n\nexport function DowngradeWorksheetNames(executeResponse: ExecuteResponse): ExecuteResponse {\n  // Fix the dashboard friendly name issue. The structures are compatible,\n  // so we still return the original reply, but we copy the SheetInfo.name\n  // into the DashboardZone.name, where v1 wants to find it.\n\n  const bootstrapInfo = executeResponse.result as ExtensionBootstrapInfo;\n  if (bootstrapInfo.extensionDashboardInfo !== undefined) {\n    bootstrapInfo.extensionDashboardInfo.zones.forEach((zone) => {\n      if (zone.sheetInfo) {\n        zone.name = zone.sheetInfo.name;\n      }\n    });\n  }\n\n  return executeResponse;\n}\n\nexport function DowngradeFlipboardZoneID(notification: Notification): Notification {\n  // Fix the FlipboardZoneId issue. Older external versions still check for flipboardZoneIDs.\n  // When running against a newer server, if flipboardZoneId is absent, set it to default(0).\n\n  if (notification.notificationId === NotificationId.SelectedMarksChanged) {\n    const visualModel = notification.data as VisualId;\n    if (visualModel.flipboardZoneID === undefined) {\n      visualModel.flipboardZoneID = 0;\n    }\n  }\n\n  return notification;\n}\n\n// Filter out formatting sheets that are specified in the classNames list\nfunction DowngradeWorksheetFormatting(executeResponse: ExecuteResponse, classNames: ClassNameKey[]): ExecuteResponse {\n  const bootstrapInfo = executeResponse.result as ExtensionBootstrapInfo;\n\n  if (bootstrapInfo?.extensionWorksheetInfo?.formatting)\n    bootstrapInfo.extensionWorksheetInfo.formatting.formattingSheets =\n      bootstrapInfo.extensionWorksheetInfo.formatting.formattingSheets.filter((x) => !classNames.includes(x.classNameKey));\n  return executeResponse;\n}\n\n// Filter out formatting sheets that are specified in the classNames list\n// Filter out formatting sheets that are specified in the classNames list\nfunction DowngradeWorksheetFormattingNotification(notification: Notification, classNames: ClassNameKey[]): Notification {\n  if (notification.notificationId === NotificationId.WorksheetFormattingChanged) {\n    const formatting = notification.data as WorkbookFormatting;\n    notification.data = formatting.formattingSheets.filter((x) => !classNames.includes(x.classNameKey));\n  }\n\n  return notification;\n}\n\n// We added new enum values for ClassNameKeys enum in 176. Need to filter them out if the client version is <176\nconst ClassNameKeysToFilter175 = [ClassNameKey.RowDividers, ClassNameKey.ColumnDividers, ClassNameKey.Pane];\n\nexport const DowngradeWorksheetFomatting175 = (response: ExecuteResponse) =>\n  DowngradeWorksheetFormatting(response, ClassNameKeysToFilter175);\nexport const DowngradeWorksheetFomattingNotification175 = (notification: Notification) =>\n  DowngradeWorksheetFormattingNotification(notification, ClassNameKeysToFilter175);\n\nexport function DowngradeExtensionEnvironmentContext(executeResponse: ExecuteResponse): ExecuteResponse {\n  // Fix the extension environment context issue. Replaces new enum values that go unrecognized\n  // by older extensions with their respective older enum values.\n  const bootstrapInfo = executeResponse.result as ExtensionBootstrapInfo;\n\n  if (bootstrapInfo.extensionEnvironment !== undefined) {\n    const context = bootstrapInfo.extensionEnvironment.extensionContext;\n    if (context === ExtensionContext.PublicWeb || context === ExtensionContext.Cloud) {\n      bootstrapInfo.extensionEnvironment.extensionContext = ExtensionContext.Server;\n    } else if (context === ExtensionContext.PublicDesktop) {\n      bootstrapInfo.extensionEnvironment.extensionContext = ExtensionContext.Desktop;\n    }\n  }\n\n  return executeResponse;\n}\n\nfunction HandleDowngradePeriodTypeForParameter(parameter: ParameterInfo) {\n  if (parameter.allowableValuesType === DomainRestrictionType.Range) {\n    if (parameter.dateStepPeriod === DateStepPeriod.IsoYears) {\n      parameter.dateStepPeriod = DateStepPeriod.Years;\n    } else if (parameter.dateStepPeriod === DateStepPeriod.IsoQuarters) {\n      parameter.dateStepPeriod = DateStepPeriod.Quarters;\n    } else if (parameter.dateStepPeriod === DateStepPeriod.IsoWeeks) {\n      parameter.dateStepPeriod = DateStepPeriod.Weeks;\n    }\n  }\n}\n\nexport function DowngradePeriodType(executeResponse: ExecuteResponse): ExecuteResponse {\n  if (Array.isArray(executeResponse.result)) {\n    const parameters = executeResponse.result as Array<ParameterInfo>;\n    for (const parameter of parameters) {\n      HandleDowngradePeriodTypeForParameter(parameter);\n    }\n  } else {\n    const parameter = executeResponse.result as ParameterInfo;\n    HandleDowngradePeriodTypeForParameter(parameter);\n  }\n\n  return executeResponse;\n}\n"]}