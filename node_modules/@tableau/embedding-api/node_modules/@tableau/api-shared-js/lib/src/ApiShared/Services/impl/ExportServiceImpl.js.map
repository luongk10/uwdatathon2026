{"version":3,"file":"ExportServiceImpl.js","sourceRoot":"","sources":["../../../../../src/ApiShared/Services/impl/ExportServiceImpl.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  ExecuteParameters,\n  ExportCrosstabSheetMap,\n  ExportFile,\n  ExportPDFOptions as InternalExportPDFOptions,\n  ParameterId,\n  VerbId,\n  VisualId,\n} from '@tableau/api-internal-contract-js';\nimport {\n  CrosstabFileFormat,\n  ExportDataOptions,\n  ExportPDFOptions as ExternalExportPDFOptions,\n  ExportScenariosForPDFAndPowerPoint,\n  SharedErrorCodes,\n  SheetType as ExternalSheetType,\n} from '@tableau/api-external-contract-js';\nimport { ExternalToInternalEnumMappings } from '../../EnumMappings/ExternalToInternalEnumMappings';\nimport { ExportHelpers } from '../../Utils/ExportHelpers';\nimport { ExportService } from '../ExportService';\nimport { ServiceNames } from '../ServiceRegistry';\nimport { ErrorHelpers } from '../../Utils/ErrorHelpers';\nimport { TableauError } from '../../TableauError';\nimport { ServiceImplBase } from './ServiceImplBase';\n\nexport class ExportServiceImpl extends ServiceImplBase implements ExportService {\n  public get serviceName(): string {\n    return ServiceNames.Export;\n  }\n\n  public getExportCrosstabSheetMapAsync(currentSheetType: ExternalSheetType): Promise<ExportCrosstabSheetMap> {\n    const verb = VerbId.GetExportCrosstabSheetMap;\n    const parameters: ExecuteParameters = {\n      [ParameterId.FunctionName]: 'getExportCrosstabSheetMapAsync',\n      [ParameterId.CurrentSheetType]: ExternalToInternalEnumMappings.sheetType.convert(currentSheetType),\n    };\n    return this.execute(verb, parameters).then<ExportCrosstabSheetMap>((response) => {\n      const result = response.result as ExportCrosstabSheetMap;\n      return result;\n    });\n  }\n\n  public async exportCrosstabAsync(\n    sheetName: string,\n    format: CrosstabFileFormat,\n    exportableWorksheetNames: Array<string>,\n    currentSheetType: ExternalSheetType,\n  ): Promise<ExportFile> {\n    ErrorHelpers.verifySheetName(exportableWorksheetNames, sheetName);\n    ErrorHelpers.verifyEnumValue<CrosstabFileFormat>(format, CrosstabFileFormat, 'CrosstabFileFormat');\n\n    // The pres layer command for exporting Crosstab uses SimpleSheetIdentifiers instead of sheet names.\n    // The extensions-and-embedding-api current does not store references to the SimpleSheetIdentifiers of its sheets\n    // so we call a pres layer command that gives us the SimpleSheetIdentifier for each sheet name that appears in the\n    // export Crosstab dialog popup.\n    const sheetNameToIdMap = await this.getExportCrosstabSheetMapAsync(currentSheetType);\n    if (!sheetNameToIdMap[sheetName]) {\n      throw new TableauError(SharedErrorCodes.InternalError, 'missing sheet doc id from sheetMap');\n    }\n\n    const parameters: ExecuteParameters = {\n      [ParameterId.FunctionName]: 'exportCrosstabAsync',\n      [ParameterId.SheetIdentifier]: sheetNameToIdMap[sheetName],\n      [ParameterId.SendNotifications]: true, // send notification on pres layer that triggers file download\n    };\n\n    // pres layer command invoked depends on the crosstab file format\n    let verb;\n    switch (format) {\n      case CrosstabFileFormat.CSV:\n        verb = VerbId.ExportCrosstabCsvDownload;\n        // CSV only parameter: see browser-clients/export-crosstab-options-dialog repo\n        parameters[ParameterId.UseTabDelimiters] = true;\n        break;\n      case CrosstabFileFormat.Excel:\n        verb = VerbId.ExportCrosstabExcelDownload;\n        break;\n      default:\n        throw new TableauError(SharedErrorCodes.InternalError, 'unsupported Crosstab file format.');\n    }\n\n    return this.execute(verb, parameters)\n      .then<ExportFile>((response) => {\n        const result = response.result as ExportFile;\n        return result;\n      })\n      .catch(() => {\n        throw new TableauError(SharedErrorCodes.CrosstabCreationError, 'An unexpected error occurred while generating the document.');\n      });\n  }\n\n  public exportDataAsync(visualId: VisualId, options: ExportDataOptions): Promise<void> {\n    ErrorHelpers.verifyExportDataOptions(options);\n\n    // Remove any duplicates from the input array\n    const columnsAsSet: Set<string> = new Set(options.columnsToIncludeById);\n    const columnsToIncludeById = Array.from(columnsAsSet);\n\n    const verb = VerbId.ExportDataDownload;\n    const parameters: ExecuteParameters = {\n      [ParameterId.FunctionName]: 'exportDataAsync',\n      [ParameterId.VisualId]: visualId,\n      [ParameterId.IgnoreAliases]: options.ignoreAliases ?? false,\n      [ParameterId.ColumnsToIncludeById]: columnsToIncludeById,\n    };\n\n    return this.execute(verb, parameters)\n      .then<void>(() => {})\n      .catch(() => {\n        throw new TableauError(SharedErrorCodes.DataCreationError, 'An unexpected error occurred while generating the document.');\n      });\n  }\n\n  public exportPowerPointAsync(sheetNames: Array<string>, exportScenarios: ExportScenariosForPDFAndPowerPoint): Promise<ExportFile> {\n    ErrorHelpers.verifySheetNamesForPDFAndPPT(sheetNames, exportScenarios);\n\n    // Note: the ExportOriginUrl param is listed as optional for the pres layer command we are invoking; however,\n    // recent changes were made that enforced the use of the empty string when invoking this command with no ExportOriginUrl.\n    // see browser-clients/export-powerpoint-options-dialog repo.\n    const verb = VerbId.ExportPowerpointDownload;\n    const parameters: ExecuteParameters = {\n      [ParameterId.FunctionName]: 'exportPowerPointAsync',\n      [ParameterId.ExportOriginUrl]: '',\n      [ParameterId.SelectedSheetNames]: sheetNames,\n    };\n\n    return this.execute(verb, parameters)\n      .then<ExportFile>((response) => {\n        const result = response.result as ExportFile;\n        return result;\n      })\n      .catch(() => {\n        throw new TableauError(\n          SharedErrorCodes.PowerPointCreationError,\n          'An error occured while attempting to generate the PowerPoint file.',\n        );\n      });\n  }\n\n  public async exportPDFAsync(\n    sheetNames: Array<string>,\n    externalExportPdfOptions: ExternalExportPDFOptions,\n    exportScenarios: ExportScenariosForPDFAndPowerPoint,\n  ): Promise<ExportFile> {\n    ErrorHelpers.verifyExportPDFOptions(externalExportPdfOptions);\n    ErrorHelpers.verifySheetNamesForPDFAndPPT(sheetNames, exportScenarios);\n\n    const internalExportPdfOptions: InternalExportPDFOptions = await this.getExportPDFOptionsAsync();\n    ExportHelpers.updateInternalExportPDFOptions(internalExportPdfOptions, externalExportPdfOptions, sheetNames);\n\n    const verb = VerbId.ExportPdfDownload;\n    const parameters: ExecuteParameters = {\n      [ParameterId.FunctionName]: 'exportPDFAsync',\n      [ParameterId.ExportPdfOptions]: internalExportPdfOptions,\n    };\n\n    return this.execute(verb, parameters)\n      .then<ExportFile>((response) => {\n        const result = response.result as ExportFile;\n        return result;\n      })\n      .catch(() => {\n        throw new TableauError(SharedErrorCodes.PDFCreationError, 'Unable to create PDF because something went wrong. Try again.');\n      });\n  }\n\n  public getExportPDFOptionsAsync(): Promise<InternalExportPDFOptions> {\n    const verb = VerbId.GetExportPdfOptions;\n    const parameters: ExecuteParameters = {\n      [ParameterId.FunctionName]: 'getExportPdfOptionsAsync',\n    };\n    return this.execute(verb, parameters).then<InternalExportPDFOptions>((response) => {\n      const result = response.result as InternalExportPDFOptions;\n      return result;\n    });\n  }\n}\n"]}