{"version":3,"file":"DataSourceServiceImpl.js","sourceRoot":"","sources":["../../../../../src/ApiShared/Services/impl/DataSourceServiceImpl.ts"],"names":[],"mappings":"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","sourcesContent":["import * as Contract from '@tableau/api-external-contract-js';\nimport { ErrorCodes } from '@tableau/api-external-contract-js';\nimport * as InternalContract from '@tableau/api-internal-contract-js';\nimport {\n  ConnectionDescriptionSummary,\n  DataSchema,\n  ExecuteParameters,\n  InternalApiDispatcher,\n  LogicalTableInfo,\n  ParameterId,\n  TableInfo,\n  TableInfos,\n  VerbId,\n  VisualId,\n} from '@tableau/api-internal-contract-js';\nimport { DataSource } from '../../DataSource';\nimport { Field } from '../../Field';\nimport { DataSourceImpl } from '../../Impl/DataSourceImpl';\nimport { FieldImpl } from '../../Impl/FieldImpl';\nimport { TableauError } from '../../TableauError';\nimport { DataSourceService } from '../DataSourceService';\nimport { ServiceNames } from '../ServiceRegistry';\nimport { ServiceImplBase } from './ServiceImplBase';\nexport class DataSourceServiceImpl extends ServiceImplBase implements DataSourceService {\n  // Since Object Model is supported since Tableau 2020.2, DataSourceServiceImpl can be initialized with the\n  // platform version when OM was supported. Once we drop support for Tableau versions <= 2020.1, all additional\n  // code in here for Object Model can be removed.\n  public constructor(dispatcher: InternalApiDispatcher, registryId: number) {\n    super(dispatcher, registryId);\n  }\n  public get serviceName(): string {\n    return ServiceNames.DataSourceService;\n  }\n\n  public refreshAsync(dataSourceId?: string): Promise<void> {\n    const parameters: ExecuteParameters = {\n      [ParameterId.FunctionName]: 'refreshAsync',\n      [ParameterId.DeltaTimeMs]: 0,\n      [ParameterId.ShouldRefreshDS]: true,\n    };\n\n    // On server: Not passing the datasource id will refresh all datasources.\n    if (dataSourceId) {\n      parameters[ParameterId.DataSourceId] = dataSourceId;\n    }\n\n    return this.execute(VerbId.RefreshDataSource, parameters).then<void>((response) => {\n      return;\n    });\n  }\n\n  public getActiveTablesAsync(dataSourceId: string): Promise<Array<TableInfo>> {\n    const joinParameters: ExecuteParameters = {\n      [ParameterId.FunctionName]: 'getActiveTablesAsync',\n      [ParameterId.DataSourceId]: dataSourceId,\n    };\n\n    // Get the description of the tables used by this connection\n    return this.execute(VerbId.GetActiveTables, joinParameters).then<Array<TableInfo>>((joinResponse) => {\n      const tableInfos = joinResponse.result as TableInfos;\n\n      // getActiveTables is unsupported for cubes and GA. We do not have a connection type property\n      // available from the platform (intentionally, to reduce code churn as new connections are added).\n      // Instead,just check if any tables are returned. This array will be empty for any non-table based datasource.\n      if (tableInfos.tables.length === 0) {\n        throw new TableauError(ErrorCodes.UnsupportedMethodForDataSourceType, `getActiveTables is not supported for: ${dataSourceId}`);\n      }\n\n      return tableInfos.tables;\n    });\n  }\n\n  public getDataSourcesAsync(visualId: VisualId): Promise<DataSchema> {\n    const parameters: ExecuteParameters = {\n      [ParameterId.FunctionName]: 'getDataSourcesAsync',\n      [ParameterId.VisualId]: visualId,\n    };\n    return this.execute(VerbId.GetDataSources, parameters).then<DataSchema>((response) => {\n      const dataSchema = response.result as DataSchema;\n      return dataSchema;\n    });\n  }\n\n  public getAllDataSourcesAsync(): Promise<DataSchema> {\n    const parameters: ExecuteParameters = {\n      [ParameterId.FunctionName]: 'getAllDataSourcesAsync',\n    };\n    return this.execute(VerbId.GetAllDataSources, parameters).then<DataSchema>((response) => {\n      const dataSchema = response.result as DataSchema;\n      return dataSchema;\n    });\n  }\n\n  public getConnectionSummariesAsync(dataSourceId: string): Promise<ConnectionDescriptionSummary[]> {\n    const params: ExecuteParameters = {\n      [ParameterId.FunctionName]: 'getConnectionSummariesAsync',\n      [ParameterId.DataSourceId]: dataSourceId,\n    };\n\n    // Get the description of the tables used by this connection\n    return this.execute(VerbId.GetConnectionDescriptionSummaries, params).then<ConnectionDescriptionSummary[]>((response) => {\n      const descriptionSummaries = response.result as ConnectionDescriptionSummary[];\n      return descriptionSummaries;\n    });\n  }\n\n  public getFieldAsync(globalfieldName: string): Promise<Contract.Field> {\n    const verb = VerbId.GetFieldAndDataSource;\n    const parameters: ExecuteParameters = {\n      [ParameterId.FunctionName]: 'getFieldAsync',\n      [ParameterId.FieldId]: globalfieldName,\n    };\n\n    return this.execute(verb, parameters).then<Contract.Field>((response) => {\n      const dataSource = response.result[ParameterId.DataSource] as InternalContract.DataSource;\n      const field = response.result[ParameterId.Field] as Field;\n      return this.convertField(field, this.convertDataSource(dataSource));\n    });\n  }\n\n  public getLogicalTablesAsync(dataSourceId: string): Promise<Array<LogicalTableInfo>> {\n    const params: ExecuteParameters = {\n      [ParameterId.FunctionName]: 'getLogicalTablesAsync',\n      [ParameterId.DataSourceId]: dataSourceId,\n    };\n    return this.execute(VerbId.GetLogicalTables, params).then<Array<LogicalTableInfo>>((response) => {\n      return response.result as Array<LogicalTableInfo>;\n    });\n  }\n\n  public getUnderlyingTablesAsync(visualId: VisualId): Promise<Array<LogicalTableInfo>> {\n    const params: ExecuteParameters = {\n      [ParameterId.FunctionName]: 'getUnderlyingTablesAsync',\n      [ParameterId.VisualId]: visualId,\n    };\n    return this.execute(VerbId.GetUnderlyingTables, params).then<Array<LogicalTableInfo>>((response) => {\n      return response.result as Array<LogicalTableInfo>;\n    });\n  }\n\n  private convertField(field: InternalContract.Field, dataSource: Contract.DataSource): Contract.Field {\n    return new Field(new FieldImpl(field, dataSource));\n  }\n\n  private convertDataSource(dataSource: InternalContract.DataSource): Contract.DataSource {\n    return new DataSource(new DataSourceImpl(dataSource, this._registryId));\n  }\n}\n"]}