{"version":3,"file":"StoryImpl.js","sourceRoot":"","sources":["../../../../src/ApiShared/Impl/StoryImpl.ts"],"names":[],"mappings":"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","sourcesContent":["import * as Contract from '@tableau/api-external-contract-js';\nimport { SheetInfo, StoryModel, StoryPointModel } from '@tableau/api-internal-contract-js';\nimport { ApiServiceRegistry, ServiceNames } from '../Services/ServiceRegistry';\nimport { StoryActivationService } from '../Services/StoryActivationService';\nimport { TableauError } from '../TableauError';\nimport { ErrorHelpers } from '../Utils/ErrorHelpers';\nimport { ShortLivedDeferred } from '../Utils/ShortLivedDeferred';\nimport { SheetImpl } from './SheetImpl';\nimport { SheetInfoImpl } from './SheetInfoImpl';\nimport { StoryPointImpl } from './StoryPointImpl';\nimport { StoryPointInfoImpl } from './StoryPointInfoImpl';\n\nexport class StoryImpl extends SheetImpl {\n  private _activeStoryPointImpl: StoryPointImpl;\n  private _storyPointInfoImpls: Array<StoryPointInfoImpl> = [];\n  private _deferred: ShortLivedDeferred<StoryPointImpl>;\n\n  public constructor(\n    protected _sheetInfoImpl: SheetInfoImpl,\n    storyModel: StoryModel,\n    private _publishedSheetInfos: Array<SheetInfo>,\n    protected _registryId: number,\n  ) {\n    super(_sheetInfoImpl, _registryId);\n    this._deferred = new ShortLivedDeferred<StoryPointImpl>();\n    this.initializeStory(storyModel);\n  }\n\n  private initializeStory(storyModel: StoryModel) {\n    storyModel.storyPoints.forEach((storyPointModel) => {\n      const isActive = storyPointModel.index === storyModel.activeStoryPointIndex;\n      const storyPointInfoImpl = new StoryPointInfoImpl(\n        storyPointModel.caption,\n        storyPointModel.index,\n        storyPointModel.storyPointId,\n        isActive,\n        storyPointModel.updated,\n        this,\n      );\n      this._storyPointInfoImpls.push(storyPointInfoImpl);\n\n      if (isActive) {\n        this._activeStoryPointImpl = new StoryPointImpl(\n          storyPointInfoImpl,\n          this._publishedSheetInfos,\n          this._registryId,\n          storyPointModel.containedSheetInfo,\n        );\n      }\n    });\n  }\n\n  private updateStoryInfo(index: number, storyPointModel: StoryPointModel) {\n    if (!this._storyPointInfoImpls) {\n      return;\n    }\n\n    let storyInfoImpl = this._storyPointInfoImpls[index];\n    if (storyInfoImpl.storyPointId !== storyPointModel.storyPointId) {\n      throw new TableauError(\n        Contract.EmbeddingErrorCodes.StoryPointIdMismatch,\n        `We should not be updating a story point when the IDs don't match. Existing storyPointID=${storyInfoImpl.storyPointId}, newStoryPointID=${storyPointModel.storyPointId}`,\n      );\n    }\n    storyInfoImpl.caption = storyPointModel.caption;\n    storyInfoImpl.updated = storyPointModel.updated;\n\n    if (this._activeStoryPointImpl.storyPointId === storyPointModel.storyPointId) {\n      this._activeStoryPointImpl.updated = storyInfoImpl.updated;\n    }\n  }\n\n  public updateStory(storyPointModel: StoryPointModel) {\n    if (!this._storyPointInfoImpls) {\n      return;\n    }\n\n    this._storyPointInfoImpls.forEach((storyPointInfoImpl) => {\n      const isActive = storyPointInfoImpl.storyPointId === storyPointModel.storyPointId;\n      if (isActive) {\n        // update the state\n        storyPointInfoImpl.caption = storyPointModel.caption;\n        storyPointInfoImpl.index = storyPointModel.index;\n        storyPointInfoImpl.active = true;\n        storyPointInfoImpl.updated = storyPointModel.updated;\n\n        // re-initialize activeStoryPointImpl\n        this._activeStoryPointImpl = new StoryPointImpl(\n          storyPointInfoImpl,\n          this._publishedSheetInfos,\n          this._registryId,\n          storyPointModel.containedSheetInfo,\n        );\n      } else {\n        // set old ones to false\n        storyPointInfoImpl.active = false;\n      }\n    });\n\n    if (this.activeStoryPoint) {\n      this._deferred.resolve(this.activeStoryPoint);\n    }\n  }\n\n  public get activeStoryPoint(): StoryPointImpl | undefined {\n    return this._activeStoryPointImpl;\n  }\n\n  public get storyPointsInfo(): Array<StoryPointInfoImpl> {\n    return this._storyPointInfoImpls;\n  }\n\n  public get isActive(): boolean {\n    return this._sheetInfoImpl.active;\n  }\n\n  public get isHidden(): boolean {\n    return !!this._sheetInfoImpl.isHidden;\n  }\n\n  public activateNextStoryPointAsync(): Promise<StoryPointImpl> {\n    if (this._activeStoryPointImpl.index === this._storyPointInfoImpls.length - 1) {\n      return Promise.resolve(this._activeStoryPointImpl);\n    }\n\n    let promise = this._deferred.getNewPromiseOrThrowIfBusy();\n\n    const service = ApiServiceRegistry.get(this._registryId).getService<StoryActivationService>(ServiceNames.StoryActivation);\n    service.activateNextStoryPointAsync();\n    return promise;\n  }\n\n  public activatePreviousStoryPointAsync(): Promise<StoryPointImpl> {\n    if (this._activeStoryPointImpl.index === 0) {\n      return Promise.resolve(this._activeStoryPointImpl);\n    }\n\n    let promise = this._deferred.getNewPromiseOrThrowIfBusy();\n\n    const service = ApiServiceRegistry.get(this._registryId).getService<StoryActivationService>(ServiceNames.StoryActivation);\n    service.activatePreviousStoryPointAsync();\n    return promise;\n  }\n\n  public activateStoryPointAsync(index: number): Promise<StoryPointImpl> {\n    ErrorHelpers.verifyParameter(index, 'index');\n    ErrorHelpers.verifyParameterType(index, 'number', 'index');\n\n    if (index < 0 || index >= this._storyPointInfoImpls.length) {\n      throw new TableauError(Contract.EmbeddingErrorCodes.IndexOutOfRange, 'The index passed to this command is out of range.');\n    }\n\n    if (index === this._activeStoryPointImpl.index) {\n      return Promise.resolve(this._activeStoryPointImpl);\n    }\n\n    let promise = this._deferred.getNewPromiseOrThrowIfBusy();\n\n    const service = ApiServiceRegistry.get(this._registryId).getService<StoryActivationService>(ServiceNames.StoryActivation);\n    service.activateStoryPointAsync(index);\n    return promise;\n  }\n\n  public revertStoryPointAsync(index: number): Promise<StoryPointInfoImpl> {\n    ErrorHelpers.verifyParameter(index, 'index');\n    ErrorHelpers.verifyParameterType(index, 'number', 'index');\n\n    if (index < 0 || index >= this._storyPointInfoImpls.length) {\n      throw new TableauError(Contract.EmbeddingErrorCodes.IndexOutOfRange, 'The index passed to this command is out of range.');\n    }\n\n    const service = ApiServiceRegistry.get(this._registryId).getService<StoryActivationService>(ServiceNames.StoryActivation);\n\n    return service.revertStoryPointAsync(index).then<StoryPointInfoImpl>((response) => {\n      this.updateStoryInfo(response.index, response);\n      const storyPointInfoImpl = new StoryPointInfoImpl(\n        response.caption,\n        response.index,\n        response.storyPointId,\n        false,\n        response.updated,\n        this,\n      );\n      return storyPointInfoImpl;\n    });\n  }\n\n  public clearPendingPromises(): void {\n    if (this._deferred) {\n      this._deferred.reject('All pending promises cleared');\n    }\n  }\n}\n"]}